var EventEmitter=function(){function e(){this.nextId=0,this.subscribers=[]}return e.prototype.subscribe=function(e){var t=this,n=this.nextId;return this.nextId+=1,void 0!==this.value&&e(this.value),this.subscribers.push({id:n,func:e}),function(){t.subscribers=t.subscribers.filter(function(e){var t=e.id;return t!==n})}},e.prototype.next=function(e){var t=this;this.value=e,this.subscribers.forEach(function(e){var n=e.func;return n(t.value)})},e}(),firebaseAppScript=document.getElementById("firebase-app"),firebaseAuthScript=document.getElementById("firebase-auth"),providers,UserService=function(){function e(){var e=this;this.user=new EventEmitter,firebaseAuthScript.onload=function(){var t={apiKey:"AIzaSyAjSDRU_Sl8DbTftnDghDsZJsxlAEvQpxE",authDomain:"fir-auth-test-fe62c.firebaseapp.com",databaseURL:"https://fir-auth-test-fe62c.firebaseio.com"};providers={google:new firebase.auth.GoogleAuthProvider,twitter:new firebase.auth.TwitterAuthProvider,facebook:new firebase.auth.FacebookAuthProvider},firebase.initializeApp(t),console.log(Object.keys(localStorage)),firebase.auth().onAuthStateChanged(function(t){var n=t.displayName,r=t.photoURL,i=t.email,o=t.uid;return e.user.next({id:o,name:n,photo:r,email:i})})}}return e.prototype.signIn=function(e){return firebase.auth().signInWithPopup(providers[e])},e.prototype.signOut=function(){return this.user.next(null),firebase.auth().signOut()},e}(),clearItemsFromCahce=function(){return Object.keys(localStorage).filter(function(e){return e.startsWith("/item")}).forEach(function(e){return localStorage.removeItem(e)})},userService=new UserService,isParentOf=function(e,t){return"HTML"!==e.nodeName&&(!!e.matches(t)||isParentOf(e.parentNode,t))};"serviceWorker"in navigator?navigator.serviceWorker.register("/service-worker.js",{scope:"/"}).then(function(e){console.log("service worker registered"),e.onupdatefound=function(){console.log("new service worker found")}}):console.log("service worker is not supported :-("),window.addEventListener("load",function(){var e=document.querySelector(".navigation"),t=document.querySelector(".header"),n=document.querySelector(".breadcrumb"),r=document.querySelector(".wrapper"),i=document.querySelector(".header__top-bar__open-nav-button"),o=document.querySelector(".navigation__close-nav-button"),a=document.querySelector(".header__top-bar__user-name"),u=document.querySelector(".header__top-bar__sign-in-button"),c=document.querySelector(".header__user"),s=document.querySelector(".header__user__name"),d=document.querySelector(".header__user__email"),l=document.querySelector(".header__user__photo"),m=document.querySelector(".header__user__sign-out-button"),f=document.querySelector(".header__img"),h=document.createElement("img");h.onload=function(){t.insertBefore(h,f),f.setAttribute("hidden","")},h.className="header__img big",h.src=headerImageSrc,u.hidden=!1;var p=function(){e.classList.add("open"),setTimeout(function(){return document.addEventListener("click",v)})},v=function(e){var t=e.target;isParentOf(t,".navigation")||b()},b=function(){e.classList.remove("open"),document.removeEventListener("click",v)},g=72,y=n||r,S=16,_=function(){var e=document.body.getBoundingClientRect().right*headerImageHWRatio,n=e-g,r=window.scrollY;r>n?(t.style.top=-n+"px",y.style.marginTop=e+S+"px",t.classList.add("small")):(y.removeAttribute("style"),t.classList.remove("small"))},w=function(e){e?(u.hidden=!0,a.hidden=!1,c.classList.remove("not-signed-in"),a.innerText=e.name,s.innerText=e.name,d.innerText=e.email,l.src=e.photo):(u.hidden=!1,a.hidden=!0,c.classList.add("not-signed-in"))},E=!0,A=function(){c.hidden=!1,E&&(setTimeout(function(){return document.addEventListener("click",L)}),E=!1)},L=function(e){e.preventDefault(),isParentOf(e.target,".header__user")||(E=!0,c.hidden=!0,document.removeEventListener("click",L))},q=function(){clearItemsFromCahce(),L({target:document.body,preventDefault:function(){return null}}),userService.signOut()};userService.user.subscribe(w),window.addEventListener("scroll",_),i.addEventListener("click",p),o.addEventListener("click",b),m.addEventListener("click",q),a.addEventListener("click",A),function(e,t,n,r,i,o,a){e.GoogleAnalyticsObject=i,e[i]=e[i]||function(){(e[i].q=e[i].q||[]).push(arguments)},e[i].l=1*new Date,o=t.createElement(n),a=t.getElementsByTagName(n)[0],o.async=1,o.src=r,a.parentNode.insertBefore(o,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-85930130-1","auto"),ga("send","pageview")});var HOST="https://83.93.98.21:8000",formToJson=function(e){var t=new FormData(e),n={};return t.forEach(function(e,t){n[t]=e}),n},addItem=function(e,t){return fetch(HOST+prefix,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:t},body:JSON.stringify(e)}).then(function(e){return e.ok?e:void e.text().then(function(e){return console.error(e)})})};window.addEventListener("load",function(){var e=document.querySelector(".login-warning"),t=document.querySelector(".add-item"),n=t.querySelector(".fields");document.querySelector(".error");fields.forEach(function(e){var t,r=e.name,i=e.type,o=e.attributes,a=document.createElement("article"),u=document.createElement("label");a.className="input-container","image"===i?(t=document.createElement("input"),t.setAttribute("type","file"),t.setAttribute("accept","image/*")):t=document.createElement(i),u.innerText=r,u.setAttribute("for",r),t.id=r,t.name=r,o&&o.split(" ").map(function(e){return e.split("=")}).forEach(function(e){var n=e[0],r=e[1];return t.setAttribute(n,(r||"").replace(/'/g,""))}),"image"===i&&a.classList.add("image"),a.appendChild(u),a.appendChild(t),n.appendChild(a)}),userService.user.subscribe(function(n){if(!n)return t.setAttribute("hidden",""),void e.removeAttribute("hidden");t.removeAttribute("hidden"),e.setAttribute("hidden","");var r=function(e){e.preventDefault();var r=formToJson(t),i=Object.keys(r).filter(function(e){return"title"!==e}).reduce(function(e,t){return e[t]=r[t],e},{}),o=Promise.all(fields.filter(function(e){return"image"===e.type}).map(function(e){return e.name}).map(function(e){var t=i[e];if(t.size){var r=new FormData,o=new XMLHttpRequest;return r.append("image",t),new Promise(function(t,a){o.onload=function(){i[e]=o.responseText,t()},o.onerror=a,o.open("POST",HOST+"/files",!0),o.setRequestHeader("Authorization",n.id),o.send(r)})}}));return o.then(function(){var e={_id:void 0,permission:void 0,title:r.title,user:{id:n.id,name:n.name,photo:n.photo,email:n.email},content:i,fields:fields.map(function(e){return e.name})};addItem(e,n.id)}).then(function(){return location.href=location.href.replace(/[\w-]+\.html$/,"")}).catch(function(e){return console.error(e)}),!1};t.addEventListener("submit",r)})});