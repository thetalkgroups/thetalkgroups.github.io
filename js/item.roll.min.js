var EventEmitter=function(){function e(){this.nextId=0;this.subscribers=[]}e.prototype.subscribe=function(e){var t=this;var r=this.nextId;this.nextId+=1;if(this.value!==undefined){e(this.value)}this.subscribers.push({id:r,func:e});return function(){t.subscribers=t.subscribers.filter(function(e){var t=e.id;return t!==r})}};e.prototype.next=function(e){var t=this;this.value=e;this.subscribers.forEach(function(e){var r=e.func;return r(t.value)})};return e}();var config={apiKey:"AIzaSyAjSDRU_Sl8DbTftnDghDsZJsxlAEvQpxE",authDomain:"fir-auth-test-fe62c.firebaseapp.com",databaseURL:"https://fir-auth-test-fe62c.firebaseio.com"};var providers={google:new firebase.auth.GoogleAuthProvider,twitter:new firebase.auth.TwitterAuthProvider,facebook:new firebase.auth.FacebookAuthProvider};firebase.initializeApp(config);var UserService=function(){function e(){var e=this;this.user=new EventEmitter;if(!Object.keys(localStorage).find(function(e){return e.startsWith("firebase")})){this.user.next(null)}firebase.auth().onAuthStateChanged(function(t){var r=t.displayName,n=t.photoURL,i=t.email,o=t.uid;return e.user.next({id:o,name:r,photo:n,email:i})})}e.prototype.signIn=function(e){return firebase.auth().signInWithPopup(providers[e])};e.prototype.signOut=function(){this.user.next(null);return firebase.auth().signOut()};return e}();var clearItemsFromCahce=function(){return Object.keys(localStorage).filter(function(e){return e.startsWith("/item")}).forEach(function(e){return localStorage.removeItem(e)})};var userService=new UserService;var isParentOf=function(e,t){if(e.nodeName==="HTML")return false;if(e.matches(t))return true;return isParentOf(e.parentNode,t)};if("serviceWorker"in navigator){navigator.serviceWorker.register("/service-worker.js",{scope:"/"}).then(function(e){console.log("service worker registered :)");e.update()})}else{console.log("service worker is not supported :-(")}window.addEventListener("load",function(){var e=document.querySelector(".navigation");var t=document.querySelector(".header");var r=document.querySelector(".breadcrumb");var n=document.querySelector(".wrapper");var i=document.querySelector(".header__top-bar__open-nav-button");var o=document.querySelector(".navigation__close-nav-button");var a=document.querySelector(".header__top-bar__user-name");var u=document.querySelector(".header__top-bar__sign-in-button");var c=document.querySelector(".header__user");var s=document.querySelector(".header__user__name");var d=document.querySelector(".header__user__email");var l=document.querySelector(".header__user__photo");var m=document.querySelector(".header__user__sign-out-button");u.hidden=false;var f=function(){e.classList.add("open");setTimeout(function(){return document.addEventListener("click",h)})};var h=function(e){var t=e.target;if(isParentOf(t,".navigation"))return;v()};var v=function(){e.classList.remove("open");document.removeEventListener("click",h)};var p=72;var y=r||n;var g=16;var _=function(){var e=document.body.getBoundingClientRect().right*headerImageHWRatio;var r=e-p;var n=window.scrollY;if(n>r){t.style.top=-r+"px";y.style.marginTop=e+g+"px";t.classList.add("small")}else{y.removeAttribute("style");t.classList.remove("small")}};var S=function(e){if(!e){u.hidden=false;a.hidden=true;c.classList.add("not-signed-in")}else{u.hidden=true;a.hidden=false;c.classList.remove("not-signed-in");a.innerText=e.name;s.innerText=e.name;d.innerText=e.email;l.src=e.photo}};var b=true;var k=function(){c.hidden=false;if(b){setTimeout(function(){return document.addEventListener("click",T)});b=false}};var T=function(e){e.preventDefault();if(isParentOf(e.target,".header__user"))return;b=true;c.hidden=true;document.removeEventListener("click",T)};var I=function(){clearItemsFromCahce();T({target:document.body,preventDefault:function(){return null}});userService.signOut()};userService.user.subscribe(S);window.addEventListener("scroll",_);i.addEventListener("click",f);o.addEventListener("click",v);m.addEventListener("click",I);a.addEventListener("click",k)});var HOST="https://83.93.98.21:8000";var collectionMap={questions:"question","tips-and-tricks":"tip","trip-reports":"report"};var getItemSingular=function(e){return collectionMap[e]};var formToJson=function(e){var t=new FormData(e);var r={};t["forEach"](function(e,t){r[t]=e});return r};var setItemToCache=function(e,t){return localStorage.setItem("/item"+e.replace("/sticky","")+"/"+t._id,JSON.stringify(t))};var getItemFromCache=function(e,t){return JSON.parse(localStorage.getItem("/item"+e.replace("/sticky","")+"/"+t))};var getPage=function(){var e=1;var t=location.search.match(/page=(\d+)/);if(t)e=parseInt(t[1],10)||1;return e};var getId=function(e){var t=location.search.match(/id=(\w+)/);if(!t){return e(new Error("id missing"))}return t[1]};var List=function(){function e(e){this.prefix=e}e.prototype.setUserId=function(e){this.userId=e};e.prototype.getItems=function(e){var t=this;return this.listItems(e).then(function(e){var r=e.ids,n=e.numberOfPages;var i=[];var o=[];r.forEach(function(e){var r=getItemFromCache(t.prefix,e);if(r)i.push(r);else o.push(e)});if(o.length===0)return{items:i,numberOfPages:n};return t.fetchItems(o).then(function(e){e.forEach(function(e){return setItemToCache(t.prefix,e)});return{items:i.concat(e),numberOfPages:n}})})};e.prototype.listItems=function(e){return fetch(HOST+this.prefix+"/list/"+e,{headers:{Authorization:this.userId||"UNSET"}}).then(function(e){if(!e.ok)return e.text().then(function(e){throw e});return e.json()})};e.prototype.fetchItems=function(e){return fetch(HOST+this.prefix+"/",{method:"POST",headers:{"Content-Type":"application/json",Authorization:this.userId||"UNSET"},body:JSON.stringify(e)}).then(function(e){if(!e.ok)return e.text().then(function(e){throw e});return e.json()})};return e}();var initPagination=function(e,t,r,n){var i=0;var o=document.querySelector(".pagination__prev");var a=document.querySelector(".pagination__next");var u=document.querySelector(".pagination__page");var c=function(){if(e===1)o.classList.add("disabled");else o.classList.remove("disabled");if(e===t)a.classList.add("disabled");else a.classList.remove("disabled");history.pushState(null,null,getUrlWithPage(e));u.innerHTML=e+" of "+t};window.addEventListener("popstate",function(){if(i===0){history.back()}else{i-=1;e=getPage();c();r(e).catch(n)}});o.onclick=function(){if(o.classList.contains("disabled"))return;e-=1;c();i+=1;r(e).catch(n)};a.onclick=function(){if(a.classList.contains("disabled"))return;e+=1;c();i+=1;r(e).catch(n)};c()};var getUrlWithPage=function(e){var t=new URL(location.href);if(e===1){t.search=t.search.replace(/&?page=\d+/,"")}else if(!t.search.match("page=")){t.search+=(t.search?"&":"")+"page="+e}else{t.search=t.search.replace(/page=\d+/,"page="+e)}return t.toString()};var userId=null;var wasUnset=false;var itemSingular=getItemSingular(collection);window.addEventListener("load",function(){var e=document.querySelector(".replys");var t=document.querySelector(".item__header");var r=document.querySelector(".item__photo");var n=document.querySelector(".item__name");var i=document.querySelector(".item__date");var o=document.querySelector(".item__title");var a=document.querySelector(".item__content");var u=document.querySelector(".item__spinner");var c=document.querySelector(".item__header .admin-actions");var s=document.querySelector(".item__header .admin-actions__ban");var d=document.querySelector(".item__header .admin-actions__kick");var l=document.querySelector(".login-warning");var m=document.querySelector(".reply-form");var f=document.querySelector(".reply-form__uploaded-image");var h=document.getElementById("image");var v=document.querySelector(".item__header__top__buttons");var p=document.querySelector(".item__delete");var y=document.querySelector(".item__sticky");var g=document.querySelector(".replys__no-replys");var _=document.querySelector(".pagination");var S=document.querySelector(".replys__spinner");var b=document.querySelector(".error");var k=document.querySelector(".error__message");var T=document.querySelector(".kick-user-prompt");var I=document.querySelector(".kick-user-prompt__amount");var q=document.querySelector(".kick-user-prompt__measurement");var A=document.querySelector(".kick-user-prompt__button");var w=document.querySelector(".kick-user-prompt__cancle");var L=document.querySelector(".breadcrumb p");L.innerHTML=getItemSingular(collection);var x=function(r){console.error(r);b.removeAttribute("hidden");k.innerHTML=r.constructor.name.endsWith("Error")?r.message:r.toString();clearTimeout(J);t.setAttribute("hidden","");S.setAttribute("hidden","");m.setAttribute("hidden","");e.setAttribute("hidden","");_.setAttribute("hidden","");l.setAttribute("hidden","")};var E=getId(x);if(!E)return;var O=prefix+("/"+E+"/replys");var P=new List(O);var H=function(e,t){return fetch(""+HOST+t+"/"+e,{method:"DELETE",headers:{Authorization:userId}}).then(function(e){if(!e.ok)return e.text().then(function(e){throw e})})};var U=function(){var e=setTimeout(function(){return u.removeAttribute("hidden")},100);return Promise.resolve(getItemFromCache(prefix,E)).then(function(e){if(e&&e.content)return e;return fetch(HOST+prefix+"/"+E,{headers:{Authorization:userId}}).then(function(e){if(!e.ok)e.text().then(function(e){throw e});else{return e.json().then(function(e){setItemToCache(prefix,e);return e})}})}).then(function(t){return{item:t,timeoutId:e}})};var C=function(e){if(e===void 0){e=false}localStorage.removeItem("/item"+prefix+"/"+E);return fetch(""+HOST+prefix+"/"+E+"/sticky",{method:"POST",body:JSON.stringify({value:e}),headers:{"Content-Type":"application/json",Authorization:userId}}).then(function(e){if(!e.ok)return e.text().then(function(e){throw e})})};var M=function(e){var t=e["image"];var r=Promise.resolve();if(t.size){var n=new FormData;var i=new XMLHttpRequest;n.append("image",t);r=new Promise(function(t,r){i.onload=function(){e["image"]=i.responseText;t()};i.onerror=r;i.open("POST",HOST+"/files",true);i.send(n)})}else{delete e["image"]}return r.then(function(){return fetch(HOST+O,{method:"PUT",body:JSON.stringify(e),headers:{"Content-Type":"application/json",Authorization:userId}})}).then(function(e){if(!e.ok)return e.text().then(function(e){throw e})})};var N=function(e){var t=document.importNode(document.getElementById("reply").content,true);var r=document.createElement("article");r.appendChild(t);var n=r.querySelector(".reply__photo");var i=r.querySelector(".reply__name");var o=r.querySelector(".reply__date");var a=r.querySelector(".reply__answer");var u=r.querySelector(".reply__image");var c=r.querySelector(".reply__delete");var s=r.querySelector(".admin-actions");var d=r.querySelector(".admin-actions__ban");var l=r.querySelector(".admin-actions__kick");r.className="reply";n.src=e.user.photo;i.innerHTML=e.user.name;o.innerHTML=moment(e.date).fromNow();a.innerHTML=e.answer;if(e.image){u.hidden=false;u.src=HOST+"/files/"+e.image}if(e.permission==="you"||e.permission==="admin"){c.removeAttribute("hidden");c.onclick=function(t){return H(e._id,O).then(function(){return history.go()}).catch(x)};if(e.permission==="admin"){var m=function(){s.setAttribute("hidden","");document.removeEventListener("click",m)};n.onclick=function(e){s.removeAttribute("hidden");setTimeout(function(){return document.addEventListener("click",m)})};d.onclick=function(t){return j(e.user.name,O,e._id)};l.onclick=function(t){return D(O,e._id)}}}return r};var j=function(e,t,r){confirm("Are you sure you want to ban '"+e+"'?")?fetch(HOST+"/users/ban/",{method:"PUT",body:JSON.stringify({prefix:t,itemId:r}),headers:{"Content-Type":"application/json",Authorization:userId}}).then(function(e){if(!e.ok)return e.text().then(function(e){throw e})}).catch(x):null};var D=function(e,t){T.removeAttribute("hidden");w.onclick=function(e){T.setAttribute("hidden","");I.value="0";q.selectedIndex=0};A.onclick=function(r){var n=parseInt(q.selectedOptions[0].value,10);var i=parseInt(I.value,10);var o=i*n;fetch(HOST+"/users/kick/"+o,{method:"PUT",body:JSON.stringify({prefix:e,itemId:t}),headers:{"Content-Type":"application/json",Authorization:userId}}).then(function(e){if(!e.ok)return e.text().then(function(e){throw e});T.setAttribute("hidden","")}).catch(x)}};var z=getPage();var J=-1;h.addEventListener("change",function(){var e=new FileReader;var t=h.files[0];e.onload=function(e){f.src=e.target.result;f.removeAttribute("hidden");f.nextElementSibling.setAttribute("hidden","")};e.readAsDataURL(t)});var F=function(e,t){clearTimeout(t);u.setAttribute("hidden","");r.src=e.user.photo;n.innerHTML=e.user.name;i.innerHTML=moment(e.date).fromNow();o.innerHTML=e.title;if(e.permission==="you"||e.permission==="admin"){v.removeAttribute("hidden");p.onclick=function(e){return confirm("Are you sure you want do delete this "+itemSingular+"?")?H(E,prefix).then(function(e){return location.href=location.href.replace(/\w+\.html.*?$/,"")}).catch(x):undefined};if(e.permission==="admin"){var l=function(){c.setAttribute("hidden","");document.removeEventListener("click",l)};r.onclick=function(e){c.removeAttribute("hidden");setTimeout(function(){return document.addEventListener("click",l)})};s.onclick=function(t){return j(e.user.name,prefix,e._id)};d.onclick=function(t){return D(prefix,e._id)};y.removeAttribute("hidden");y.innerHTML=e.sticky?"remove sticky":"mark as sticky";y.onclick=function(t){return confirm("Are you sure you want to "+(e.sticky?"mark this "+itemSingular+" as sticky":"remove sticky from this "+itemSingular))?C(e.sticky).then(function(e){return history.go()}).catch(x):undefined}}}var m=Object.keys(e.content).reduce(function(t,r){return t+('<div class="'+r+'">'+e.content[r]+"</div>")},"");a.innerHTML=m};var R=function(t){J=setTimeout(function(){return S.removeAttribute("hidden")},100);e.innerHTML="";return P.getItems(t).then(function(t){clearTimeout(J);S.setAttribute("hidden","");var r=t.items,n=t.numberOfPages;r.map(function(e){return N(e)}).forEach(function(t){return e.appendChild(t)});return t})};U().then(function(e){if(e.item.permission==="none"){wasUnset=true}return e}).then(function(e){var t=e.item,r=e.timeoutId;return F(t,r)}).catch(x);userService.user.subscribe(function(e){userId=e?e.id:null;P.setUserId(userId);if(userId&&wasUnset){localStorage.removeItem("/item"+prefix+"/"+E)}U().then(function(e){var t=e.item,r=e.timeoutId;return F(t,r)}).catch(x);R(z).then(function(e){var t=e.items,r=e.numberOfPages;if(r===1||r===0){_.setAttribute("hidden","")}else{initPagination(z,r,R,x)}if(t.length===0){g.removeAttribute("hidden")}}).catch(x);if(!e){l.removeAttribute("hidden");m.setAttribute("hidden","");v.setAttribute("hidden","");return}l.setAttribute("hidden","");m.removeAttribute("hidden");m.onsubmit=function(t){var r=formToJson(m);t.preventDefault();r["user"]=e;M(r).then(function(){return history.go()}).catch(x);return false}})});