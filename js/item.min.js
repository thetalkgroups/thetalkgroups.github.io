var EventEmitter=function(){function e(){this.nextId=0,this.subscribers=[]}return e.prototype.subscribe=function(e){var t=this,n=this.nextId;return this.nextId+=1,void 0!==this.value&&e(this.value),this.subscribers.push({id:n,func:e}),function(){t.subscribers=t.subscribers.filter(function(e){var t=e.id;return t!==n})}},e.prototype.next=function(e){var t=this;this.value=e,this.subscribers.forEach(function(e){var n=e.func;return n(t.value)})},e}(),firebaseAuthScript=document.getElementById("firebase-auth"),providers,UserService=function(){function e(){var e=this;this.user=new EventEmitter,firebaseAuthScript.onload=function(){var t={apiKey:"AIzaSyAjSDRU_Sl8DbTftnDghDsZJsxlAEvQpxE",authDomain:"fir-auth-test-fe62c.firebaseapp.com",databaseURL:"https://fir-auth-test-fe62c.firebaseio.com"};providers={google:new firebase.auth.GoogleAuthProvider,twitter:new firebase.auth.TwitterAuthProvider,facebook:new firebase.auth.FacebookAuthProvider},firebase.initializeApp(t),firebase.auth().onAuthStateChanged(function(t){var n=t.displayName,r=t.photoURL,i=t.email,o=t.uid;return e.user.next({id:o,name:n,photo:r,email:i})})}}return e.prototype.signIn=function(e){return firebase.auth().signInWithPopup(providers[e])},e.prototype.signOut=function(){return this.user.next(null),firebase.auth().signOut()},e}(),clearItemsFromCahce=function(){return Object.keys(localStorage).filter(function(e){return e.startsWith("/item")}).forEach(function(e){return localStorage.removeItem(e)})},userService=new UserService,isParentOf=function(e,t){return"HTML"!==e.nodeName&&(!!e.matches(t)||isParentOf(e.parentNode,t))};"matches"in HTMLElement.prototype||(HTMLElement.prototype.matches=HTMLElement.prototype.msMatchesSelector),"serviceWorker"in navigator?navigator.serviceWorker.register("/service-worker.js",{scope:"/"}).then(function(e){console.log("service worker registered"),e.onupdatefound=function(){console.log("new service worker found")}}):console.warn("service worker is not supported :-("),window.addEventListener("load",function(){var e=document.querySelector(".navigation"),t=document.querySelector(".header"),n=document.querySelector(".breadcrumb"),r=document.querySelector(".wrapper"),i=document.querySelector(".header__top-bar__open-nav-button"),o=document.querySelector(".navigation__close-nav-button"),c=document.querySelector(".header__top-bar__user-name"),u=document.querySelector(".header__top-bar__sign-in-button"),s=document.querySelector(".header__user"),a=document.querySelector(".header__user__name"),d=document.querySelector(".header__user__email"),m=document.querySelector(".header__user__photo"),l=document.querySelector(".header__user__sign-out-button"),h=document.querySelector(".header__img"),f=document.createElement("img");f.onload=function(){t.insertBefore(f,h),h.setAttribute("hidden","")},f.className="header__img big",f.src=headerImageSrc,u.hidden=!1;var p=function(){e.classList.add("open"),setTimeout(function(){return document.addEventListener("click",v)})},v=function(e){var t=e.target;isParentOf(t,".navigation")||y()},y=function(){e.classList.remove("open"),document.removeEventListener("click",v)},g=72,_=n||r,S=16,b=function(){var e=document.body.getBoundingClientRect().right*headerImageHWRatio,n=e-g,r=window.scrollY;r>n?(t.style.top=-n+"px",_.style.marginTop=e+S+"px",t.classList.add("small")):(_.removeAttribute("style"),t.classList.remove("small"))},k=function(e){e?(u.hidden=!0,c.hidden=!1,s.classList.remove("not-signed-in"),c.innerText=e.name,a.innerText=e.name,d.innerText=e.email,m.src=e.photo):(u.hidden=!1,c.hidden=!0,s.classList.add("not-signed-in"))},T=!0,q=function(){s.hidden=!1,T&&(setTimeout(function(){return document.addEventListener("click",w)}),T=!1)},w=function(e){e.preventDefault(),isParentOf(e.target,".header__user")||(T=!0,s.hidden=!0,document.removeEventListener("click",w))},I=function(){clearItemsFromCahce(),w({target:document.body,preventDefault:function(){return null}}),userService.signOut()};userService.user.subscribe(k),window.addEventListener("scroll",b),i.addEventListener("click",p),o.addEventListener("click",y),l.addEventListener("click",I),c.addEventListener("click",q),function(e,t,n,r,i,o,c){e.GoogleAnalyticsObject=i,e[i]=e[i]||function(){(e[i].q=e[i].q||[]).push(arguments)},e[i].l=1*new Date,o=t.createElement(n),c=t.getElementsByTagName(n)[0],o.async=1,o.src=r,c.parentNode.insertBefore(o,c)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-85930130-1","auto"),ga("send","pageview")});var HOST="https://83.93.98.21:8000",collectionMap={questions:"question","tips-and-tricks":"tip","trip-reports":"report"},getItemSingular=function(e){return collectionMap[e]},formToJson=function(e){var t=new FormData(e),n={};return t.forEach(function(e,t){n[t]=e}),n},setItemToCache=function(e,t){return localStorage.setItem("/item"+e.replace("/sticky","")+"/"+t._id,JSON.stringify(t))},getItemFromCache=function(e,t){return JSON.parse(localStorage.getItem("/item"+e.replace("/sticky","")+"/"+t))},getPage=function(){var e=1,t=location.search.match(/page=(\d+)/);return t&&(e=parseInt(t[1],10)||1),e},getId=function(e){var t=location.search.match(/id=(\w+)/);return t?t[1]:e(new Error("id missing"))},List=function(){function e(e){this.prefix=e}return e.prototype.setUserId=function(e){this.userId=e},e.prototype.getItems=function(e){var t=this;return this.listItems(e).then(function(e){var n=e.ids,r=e.numberOfPages,i=[],o=[];return n.forEach(function(e){var n=getItemFromCache(t.prefix,e);n?i.push(n):o.push(e)}),0===o.length?{items:i,numberOfPages:r}:t.fetchItems(o).then(function(e){return e.forEach(function(e){return setItemToCache(t.prefix,e)}),{items:i.concat(e),numberOfPages:r}})})},e.prototype.listItems=function(e){return fetch(HOST+this.prefix+"/list/"+e,{headers:{Authorization:this.userId||"UNSET"}}).then(function(e){return e.ok?e.json():e.text().then(function(e){throw e})})},e.prototype.fetchItems=function(e){return fetch(HOST+this.prefix+"/",{method:"POST",headers:{"Content-Type":"application/json",Authorization:this.userId||"UNSET"},body:JSON.stringify(e)}).then(function(e){return e.ok?e.json():e.text().then(function(e){throw e})})},e}(),initPagination=function(e,t,n,r){var i=0,o=document.querySelector(".pagination__prev"),c=document.querySelector(".pagination__next"),u=document.querySelector(".pagination__page"),s=function(){1===e?o.classList.add("disabled"):o.classList.remove("disabled"),e===t?c.classList.add("disabled"):c.classList.remove("disabled"),history.pushState(null,null,getUrlWithPage(e)),u.innerHTML=e+" of "+t};window.addEventListener("popstate",function(){0===i?history.back():(i-=1,e=getPage(),s(),n(e).catch(r))}),o.onclick=function(){o.classList.contains("disabled")||(e-=1,s(),i+=1,n(e).catch(r))},c.onclick=function(){c.classList.contains("disabled")||(e+=1,s(),i+=1,n(e).catch(r))},s()},getUrlWithPage=function(e){var t=new URL(location.href);return 1===e?t.search=t.search.replace(/&?page=\d+/,""):t.search.match("page=")?t.search=t.search.replace(/page=\d+/,"page="+e):t.search+=(t.search?"&":"")+"page="+e,t.toString()},userId=null,wasUnset=!1,itemSingular=getItemSingular(collection);window.addEventListener("load",function(){var e=document.querySelector(".replys"),t=document.querySelector(".item__header"),n=document.querySelector(".item__photo"),r=document.querySelector(".item__name"),i=document.querySelector(".item__date"),o=document.querySelector(".item__title"),c=document.querySelector(".item__content"),u=document.querySelector(".item__spinner"),s=document.querySelector(".item__header .admin-actions"),a=document.querySelector(".item__header .admin-actions__ban"),d=document.querySelector(".item__header .admin-actions__kick"),m=document.querySelector(".login-warning"),l=document.querySelector(".reply-form"),h=document.querySelector(".reply-form__uploaded-image"),f=document.getElementById("image"),p=document.querySelector(".item__header__top__buttons"),v=document.querySelector(".item__delete"),y=document.querySelector(".item__sticky"),g=document.querySelector(".replys__no-replys"),_=document.querySelector(".pagination"),S=document.querySelector(".replys__spinner"),b=document.querySelector(".error"),k=document.querySelector(".error__message"),T=document.querySelector(".kick-user-prompt"),q=document.querySelector(".kick-user-prompt__amount"),w=document.querySelector(".kick-user-prompt__measurement"),I=document.querySelector(".kick-user-prompt__button"),A=document.querySelector(".kick-user-prompt__cancle"),L=document.querySelector(".breadcrumb p");L.innerHTML=getItemSingular(collection);var E=function(n){console.error(n),b.removeAttribute("hidden"),k.innerHTML=n.constructor.name.endsWith("Error")?n.message:n.toString(),clearTimeout(J),t.setAttribute("hidden",""),S.setAttribute("hidden",""),l.setAttribute("hidden",""),e.setAttribute("hidden",""),_.setAttribute("hidden",""),m.setAttribute("hidden","")},x=getId(E);if(x){var O=prefix+("/"+x+"/replys"),H=new List(O),P=function(e,t){return fetch(""+HOST+t+"/"+e,{method:"DELETE",headers:{Authorization:userId}}).then(function(e){if(!e.ok)return e.text().then(function(e){throw e})})},M=function(){var e=setTimeout(function(){return u.removeAttribute("hidden")},100);return Promise.resolve(getItemFromCache(prefix,x)).then(function(e){return e&&e.content?e:fetch(HOST+prefix+"/"+x,{headers:{Authorization:userId}}).then(function(e){return e.ok?e.json().then(function(e){return setItemToCache(prefix,e),e}):void e.text().then(function(e){throw e})})}).then(function(t){return{item:t,timeoutId:e}})},U=function(e){return void 0===e&&(e=!1),localStorage.removeItem("/item"+prefix+"/"+x),fetch(""+HOST+prefix+"/"+x+"/sticky",{method:"POST",body:JSON.stringify({value:e}),headers:{"Content-Type":"application/json",Authorization:userId}}).then(function(e){if(!e.ok)return e.text().then(function(e){throw e})})},N=function(e){var t=e.image,n=Promise.resolve();if(t.size){var r=new FormData,i=new XMLHttpRequest;r.append("image",t),n=new Promise(function(t,n){i.onload=function(){e.image=i.responseText,t()},i.onerror=n,i.open("POST",HOST+"/files",!0),i.setRequestHeader("Authorization",userId),i.send(r)})}else delete e.image;return n.then(function(){return fetch(HOST+O,{method:"PUT",body:JSON.stringify(e),headers:{"Content-Type":"application/json",Authorization:userId}})}).then(function(e){if(!e.ok)return e.text().then(function(e){throw e})})},C=function(e){var t=document.importNode(document.getElementById("reply").content,!0),n=document.createElement("article");n.appendChild(t);var r=n.querySelector(".reply__photo"),i=n.querySelector(".reply__name"),o=n.querySelector(".reply__date"),c=n.querySelector(".reply__answer"),u=n.querySelector(".reply__image"),s=n.querySelector(".reply__delete"),a=n.querySelector(".admin-actions"),d=n.querySelector(".admin-actions__ban"),m=n.querySelector(".admin-actions__kick");if(n.className="reply",r.src=e.user.photo,i.innerHTML=e.user.name,o.innerHTML=moment(e.date).fromNow(),c.innerHTML=e.answer,e.image&&(u.hidden=!1,u.src=HOST+"/files/"+e.image),("you"===e.permission||"admin"===e.permission)&&(s.removeAttribute("hidden"),s.onclick=function(t){return P(e._id,O).then(function(){return history.go()}).catch(E)},"admin"===e.permission)){var l=function(){a.setAttribute("hidden",""),document.removeEventListener("click",l)};r.onclick=function(e){a.removeAttribute("hidden"),setTimeout(function(){return document.addEventListener("click",l)})},d.onclick=function(t){return j(e.user.name,O,e._id)},m.onclick=function(t){return D(O,e._id)}}return n},j=function(e,t,n){confirm("Are you sure you want to ban '"+e+"'?")?fetch(HOST+"/users/ban/",{method:"PUT",body:JSON.stringify({prefix:t,itemId:n}),headers:{"Content-Type":"application/json",Authorization:userId}}).then(function(e){if(!e.ok)return e.text().then(function(e){throw e})}).catch(E):null},D=function(e,t){T.removeAttribute("hidden"),A.onclick=function(e){T.setAttribute("hidden",""),q.value="0",w.selectedIndex=0},I.onclick=function(n){var r=parseInt(w.selectedOptions[0].value,10),i=parseInt(q.value,10),o=i*r;fetch(HOST+"/users/kick/"+o,{method:"PUT",body:JSON.stringify({prefix:e,itemId:t}),headers:{"Content-Type":"application/json",Authorization:userId}}).then(function(e){return e.ok?void T.setAttribute("hidden",""):e.text().then(function(e){throw e})}).catch(E)}},z=getPage(),J=-1;f.addEventListener("change",function(){var e=new FileReader,t=f.files[0];e.onload=function(e){h.src=e.target.result,h.removeAttribute("hidden"),h.nextElementSibling.setAttribute("hidden","")},e.readAsDataURL(t)});var R=function(e,t){if(clearTimeout(t),u.setAttribute("hidden",""),n.src=e.user.photo,r.innerHTML=e.user.name,i.innerHTML=moment(e.date).fromNow(),o.innerHTML=e.title,("you"===e.permission||"admin"===e.permission)&&(p.removeAttribute("hidden"),v.onclick=function(e){return confirm("Are you sure you want do delete this "+itemSingular+"?")?P(x,prefix).then(function(e){return location.href=location.href.replace(/\w+\.html.*?$/,"")}).catch(E):void 0},"admin"===e.permission)){var m=function(){s.setAttribute("hidden",""),document.removeEventListener("click",m)};n.onclick=function(e){s.removeAttribute("hidden"),setTimeout(function(){return document.addEventListener("click",m)})},a.onclick=function(t){return j(e.user.name,prefix,e._id)},d.onclick=function(t){return D(prefix,e._id)},y.removeAttribute("hidden"),y.innerHTML=e.sticky?"remove sticky":"mark as sticky",y.onclick=function(t){return confirm("Are you sure you want to "+(e.sticky?"mark this "+itemSingular+" as sticky":"remove sticky from this "+itemSingular))?U(e.sticky).then(function(e){return history.go()}).catch(E):void 0}}var l=Object.keys(e.content).reduce(function(t,n){return t+('<div class="'+n+'">'+e.content[n]+"</div>")},"");c.innerHTML=l},F=function(t){return J=setTimeout(function(){return S.removeAttribute("hidden")},100),e.innerHTML="",H.getItems(t).then(function(t){clearTimeout(J),S.setAttribute("hidden","");var n=t.items;t.numberOfPages;return n.map(function(e){return C(e)}).forEach(function(t){return e.appendChild(t)}),t})};M().then(function(e){return"none"===e.item.permission&&(wasUnset=!0),e}).then(function(e){var t=e.item,n=e.timeoutId;return R(t,n)}).catch(E),userService.user.subscribe(function(e){return userId=e?e.id:null,H.setUserId(userId),userId&&wasUnset&&localStorage.removeItem("/item"+prefix+"/"+x),M().then(function(e){var t=e.item,n=e.timeoutId;return R(t,n)}).catch(E),F(z).then(function(e){var t=e.items,n=e.numberOfPages;1===n||0===n?_.setAttribute("hidden",""):initPagination(z,n,F,E),0===t.length&&g.removeAttribute("hidden")}).catch(E),e?(m.setAttribute("hidden",""),l.removeAttribute("hidden"),void(l.onsubmit=function(t){var n=formToJson(l);return t.preventDefault(),n.user=e,N(n).then(function(){return history.go()}).catch(E),!1})):(m.removeAttribute("hidden"),l.setAttribute("hidden",""),void p.setAttribute("hidden",""))})}});